---
layout: post
title: Spark On Kubernetes éƒ¨ç½²æŒ‡å—
categories: [Spark, Kubernetes]
description: è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Kubernetes ä¸Šéƒ¨ç½²å’Œè¿è¡Œ Spark åº”ç”¨
keywords: Spark, Kubernetes, K8s, å¤§æ•°æ®, éƒ¨ç½²
---

# ğŸš€ Spark on Kubernetes éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—æ¼”ç¤ºå¦‚ä½•åœ¨ Kubernetes ä¸Šå®‰è£…å¹¶è¿è¡Œ Sparkï¼ŒåŒ…æ‹¬ï¼š

1. å®‰è£… Spark Operator
2. é…ç½® ServiceAccount å’Œæƒé™
3. åˆ›å»ºæŒä¹…åŒ–å­˜å‚¨å·
4. ç¼–å†™å¹¶éƒ¨ç½² Spark Application

---

## 1ï¸âƒ£ å®‰è£… Spark Operator

**æ¨èä½¿ç”¨ Helm å®‰è£…ï¼š**

```bash
# æ·»åŠ  Helm ä»“åº“
helm repo add spark-operator https://kubeflow.github.io/spark-operator
helm repo update

# å®‰è£… Spark Operator
helm install spark-operator spark-operator/spark-operator \
  --namespace spark-operator \
  --create-namespace \
  --set spark.jobNamespaces="{spark-operator}" \
  --set controller.nodeSelector."kubernetes\.io/hostname"="xxt" \
  --set webhook.nodeSelector."kubernetes\.io/hostname"="xxt"
```

> ğŸ“¦ **ç½‘ç»œä¸ä½³æ—¶ï¼Œå¯ä¸‹è½½æºç åŒ…å®‰è£…ï¼š**

```bash
wget https://github.com/kubeflow/spark-operator/releases/download/spark-operator-chart-1.4.6/spark-operator-1.4.6.tgz

helm install spark-operator ./spark-operator-1.4.6.tgz \
  --namespace spark-operator \
  --create-namespace
```

å®‰è£…éªŒè¯ï¼š

```bash
kubectl get pods -n spark-operator
```

ç¤ºä¾‹è¾“å‡ºï¼š

```
NAME                              READY   STATUS    RESTARTS   AGE
spark-operator-7dcb44748b-cbjfr   1/1     Running   0          2d18h
```

ç¡®è®¤ç›‘å¬çš„å‘½åç©ºé—´ï¼š

```bash
kubectl get deployment spark-operator-controller -n spark-operator -o yaml | grep namespaces
```

---

## 2ï¸âƒ£ é…ç½® ServiceAccount å’Œæƒé™

Spark Driver å’Œ Executor éœ€è¦å…·å¤‡é›†ç¾¤è®¿é—®æƒé™ã€‚

### 2.1 åˆ›å»º ServiceAccount

åˆ›å»º `spark-account.yaml`ï¼š

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: spark-account
  namespace: spark-operator
```

### 2.2 åˆ›å»º ClusterRoleBinding

åˆ›å»º `spark-role-binding.yaml`ï¼š

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: spark-cluster-role-binding
subjects:
  - kind: ServiceAccount
    name: spark-account
    namespace: spark-operator
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: rbac.authorization.k8s.io
```

> âš ï¸ **æç¤ºï¼š** å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œç”Ÿäº§ç¯å¢ƒè¯·ä½¿ç”¨**æœ€å°æƒé™åŸåˆ™**ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ `cluster-admin`ã€‚

### 2.3 åº”ç”¨é…ç½®

```bash
kubectl apply -f spark-account.yaml
kubectl apply -f spark-role-binding.yaml
```

éªŒè¯ï¼š

```bash
kubectl get serviceaccount spark-account -n spark-operator
kubectl get clusterrolebinding spark-cluster-role-binding
```

âœ… æˆåŠŸåï¼Œ`spark-account` å·²å…·å¤‡æƒé™ã€‚

---

## 3ï¸âƒ£ åˆ›å»ºå­˜å‚¨å·

å¦‚éœ€æŒ‚è½½å…±äº«æ•°æ®ï¼Œå¯é…ç½® PV å’Œ PVCã€‚

### 3.1 åˆ›å»º PersistentVolume (PV)

åˆ›å»º `pv.yaml`ï¼š

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: spark-pv
spec:
  capacity:
    storage: 2Gi
  accessModes:
    - ReadWriteMany
  hostPath:
    path: /Users/xjw/software/spark-operator/data/spark
    type: DirectoryOrCreate
  storageClassName: local-storage
```

> ğŸ“¢ **æ³¨æ„ï¼š** `hostPath` ä»…ç”¨äº**å•èŠ‚ç‚¹æµ‹è¯•ç¯å¢ƒ**ã€‚

### 3.2 åˆ›å»º PersistentVolumeClaim (PVC)

åˆ›å»º `pvc.yaml`ï¼š

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: spark-pvc
  namespace: spark-operator
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 2Gi
  storageClassName: local-storage
```

### 3.3 éƒ¨ç½² PV å’Œ PVC

```bash
kubectl apply -f pv.yaml
kubectl apply -f pvc.yaml
```

éªŒè¯ç»‘å®šçŠ¶æ€ï¼š

```bash
kubectl get pv
kubectl get pvc -n spark-operator
```

---

## 4ï¸âƒ£ éƒ¨ç½² Spark Application

ä»¥ä¸‹ç¤ºä¾‹è¿è¡Œ Spark Piï¼š

åˆ›å»º `spark-custom.yaml`ï¼š

```yaml
apiVersion: sparkoperator.k8s.io/v1beta2
kind: SparkApplication
metadata:
  name: spark-pi-custom-resource
  namespace: spark-operator
spec:
  type: Scala
  mode: cluster
  image: spark:3.5.5
  imagePullPolicy: IfNotPresent
  mainClass: org.apache.spark.examples.SparkPi
  mainApplicationFile: "local:///opt/spark/examples/jars/spark-examples_2.12-3.5.5.jar"
  sparkVersion: 3.5.5
  restartPolicy:
    type: Never
  arguments:
    - "10000"
  sparkConf:
    "spark.driver.extraJavaOptions": "-Dlog4j.configurationFile=file:/mnt/data/log4j2.properties"
    "spark.executor.extraJavaOptions": "-Dlog4j.configurationFile=file:/mnt/data/log4j2.properties"
  volumes:
    - name: spark-storage
      persistentVolumeClaim:
        claimName: spark-pvc
    - name: host-time
      hostPath:
        path: /etc/localtime
  driver:
    cores: 1
    memory: 512m
    serviceAccount: spark-account
    nodeSelector:
      kubernetes.io/hostname: xjw
    volumeMounts:
      - name: spark-storage
        mountPath: /mnt/data
      - name: host-time
        mountPath: /etc/localtime
        readOnly: true
    env:
      - name: TZ
        value: Asia/Shanghai
  executor:
    cores: 1
    instances: 2
    memory: 512m
    nodeSelector:
      kubernetes.io/hostname: xjw
    volumeMounts:
      - name: spark-storage
        mountPath: /mnt/data
      - name: host-time
        mountPath: /etc/localtime
        readOnly: true
    env:
      - name: TZ
        value: Asia/Shanghai
```

éƒ¨ç½²ï¼š

```bash
kubectl apply -f spark-custom.yaml
```

---

## 5ï¸âƒ£ éªŒè¯è¿è¡Œä¸æŒ‚è½½

æŸ¥çœ‹ Application çŠ¶æ€ï¼š

```bash
kubectl describe sparkapplication spark-pi-custom-resource -n spark-operator
```

ç¡®è®¤æŒ‚è½½ï¼š

```
Mounts:
  /mnt/data from spark-storage (rw)
```

æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
kubectl logs spark-pi-custom-resource-driver -n spark-operator
```

è‹¥è¿è¡ŒæˆåŠŸï¼Œæ—¥å¿—æœ«å°¾åº”åŒ…å«ï¼š

```
Pi is roughly 3.1460957304786525
```

---

## 6ï¸âƒ£ æ¸…ç†èµ„æº

åˆ é™¤ Pod å’Œ Spark Applicationï¼š

```bash
kubectl delete pod spark-pi-custom-resource-driver -n spark-operator
kubectl delete sparkapplication spark-pi-custom-resource -n spark-operator
```

---

## âœ¨ å°è´´å£«

âœ… **ç‰ˆæœ¬å…¼å®¹**
`spec.sparkVersion` ä¸é•œåƒç‰ˆæœ¬éœ€ä¿æŒä¸€è‡´ã€‚

âœ… **è®¿é—® Spark UI**
å¯ä½¿ç”¨ç«¯å£è½¬å‘ï¼š

```bash
kubectl port-forward svc/spark-pi-custom-resource-ui-svc 4040:4040 -n spark-operator
```

âœ… **å¤šç§Ÿæˆ·å®‰å…¨**
ç”Ÿäº§ç¯å¢ƒå»ºè®®è‡ªå®šä¹‰ `Role` è€Œé `cluster-admin`ã€‚

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Spark Operator å®˜æ–¹æ–‡æ¡£](https://github.com/kubeflow/spark-operator)
- [Spark å®˜æ–¹æ–‡æ¡£](https://spark.apache.org/docs/latest/)
